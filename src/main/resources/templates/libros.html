<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Libros - BiblioLectum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* Estilo simple para la miniatura en la tabla */
        .tabla-portada {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold">Inventario de Libros</h1>
            <p class="text-secondary">Catálogo bibliográfico y portadas</p>
        </div>
        <button class="btn btn-primary d-flex align-items-center gap-2" onclick="abrirModalNuevo()">
            <span class="material-symbols-outlined">library_add</span> Nuevo Libro
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th class="text-center">Portada</th>
                    <th>Título / Autor</th>
                    <th>Categoría</th>
                    <th>Stock</th>
                    <th class="text-end">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="l : ${libros}">
                    <td th:text="${l.id}">1</td>

                    <td class="text-center">
                        <img th:src="@{'/images/' + ${l.portadaUrl != null ? l.portadaUrl : 'default.jpg'}}"
                             class="tabla-portada"
                             alt="Portada"
                             onerror="this.src='/images/default.jpg'">
                    </td>

                    <td>
                        <div class="fw-bold" th:text="${l.titulo}">Don Quijote</div>
                        <div class="text-muted small" th:text="${l.autor}">Cervantes</div>
                        <div class="text-muted small" style="font-size: 0.75rem;">ISBN: <span th:text="${l.isbn}">123</span></div>
                    </td>

                    <td>
                        <span th:if="${l.categoria != null}" class="badge bg-secondary" th:text="${l.categoria.nombre}">Novela</span>
                        <span th:if="${l.categoria == null}" class="badge bg-warning text-dark">Sin Cat.</span>
                    </td>

                    <td th:text="${l.stockTotal}">10</td>

                    <td class="text-end">
                        <button class="btn btn-sm btn-warning me-1"
                                onclick="editarLibro(this)"
                                th:data-id="${l.id}"
                                th:data-titulo="${l.titulo}"
                                th:data-autor="${l.autor}"
                                th:data-isbn="${l.isbn}"
                                th:data-stock="${l.stockTotal}"
                                th:data-categoria="${l.categoria != null ? l.categoria.id : ''}"
                                th:data-foto="${l.portadaUrl}"> <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
                        </button>

                        <a th:href="@{/libros/eliminar/{id}(id=${l.id})}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('¿Seguro que deseas eliminar este libro?')">
                            <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>

            <div th:if="${libros.empty}" class="p-4 text-center text-muted">
                No hay libros registrados en el inventario.
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalLibro" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <div class="modal-content">
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitulo">Nuevo Libro</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form th:action="@{/libros/guardar}" th:object="${libro}" method="post" enctype="multipart/form-data" id="formLibro">
            <div class="modal-body">

                <input type="hidden" th:field="*{id}" id="id">
                <input type="hidden" th:field="*{portadaUrl}" id="portadaUrlActual">

                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título</label>
                            <input type="text" th:field="*{titulo}" id="titulo" class="form-control" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Autor</label>
                                <input type="text" th:field="*{autor}" id="autor" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">ISBN</label>
                                <input type="text" th:field="*{isbn}" id="isbn" class="form-control">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Categoría</label>
                                <select th:field="*{categoria}" id="categoria" class="form-select" required>
                                    <option value="">Seleccione...</option>
                                    <option th:each="c : ${categorias}"
                                            th:value="${c.id}"
                                            th:text="${c.nombre}"></option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Stock</label>
                                <input type="number" th:field="*{stockTotal}" id="stock" class="form-control" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 border-start text-center">
                        <label class="form-label fw-bold mb-3">Portada del Libro</label>

                        <div class="border rounded p-2 mb-3 bg-white d-flex align-items-center justify-content-center" style="height: 200px;">
                            <img id="imgPreview" src="/images/default.jpg" class="img-fluid" style="max-height: 100%;" alt="Vista Previa">
                        </div>

                        <input type="file" name="file" id="fileInput" class="form-control form-control-sm" accept="images/png, image/jpeg" onchange="previewImage(this)">
                        <div class="form-text text-muted small">Formatos: JPG, PNG</div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Libro</button>
            </div>
        </form>
    </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let myModal;

    document.addEventListener('DOMContentLoaded', function() {
        myModal = new bootstrap.Modal(document.getElementById('modalLibro'));
    });

    function abrirModalNuevo() {
        document.getElementById('formLibro').reset();
        document.getElementById('id').value = '';

        // Resetear imagen a default
        document.getElementById('imgPreview').src = '/images/default.jpg';

        document.getElementById('modalTitulo').innerText = 'Nuevo Libro';
        myModal.show();
    }

    function editarLibro(btn) {
        // Llenar campos de texto
        document.getElementById('id').value = btn.getAttribute('data-id');
        document.getElementById('titulo').value = btn.getAttribute('data-titulo');
        document.getElementById('autor').value = btn.getAttribute('data-autor');
        document.getElementById('isbn').value = btn.getAttribute('data-isbn');
        document.getElementById('stock').value = btn.getAttribute('data-stock');

        // Seleccionar categoría en el combo
        document.getElementById('categoria').value = btn.getAttribute('data-categoria');

        // --- LÓGICA DE FOTO ---
        let nombreFoto = btn.getAttribute('data-foto');
        document.getElementById('portadaUrlActual').value = nombreFoto;

        if (nombreFoto && nombreFoto !== 'null' && nombreFoto !== '') {
            document.getElementById('imgPreview').src = '/images/' + nombreFoto;
        } else {
            document.getElementById('imgPreview').src = '/images/default.jpg';
        }

        document.getElementById('modalTitulo').innerText = 'Editar Libro';
        myModal.show();
    }

    // Función para ver la foto apenas la seleccionas del PC
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imgPreview').src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>

</body>
</html>